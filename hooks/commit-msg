#!/usr/bin/env python
# -*- coding: utf-8 -*-
import re
import sys
import os

types = """
* ğŸ‰ new              A new repo
* ğŸ’¥ BREAKING CHANGE  A breaking API change - SemVar MAJOR
* âœ¨ feat             A new feature - SemVar MINOR
* ğŸ› fix              A bug fix - SemVar PATCH
* ğŸ—‘ï¸  revert           Revert a commit
* ğŸ› ï¸  build            Change to build system
* â™»ï¸  chore            Change to tooling/config/!src/!test
* âš™ï¸  ci               Change to CI pipeline/workflow
* ğŸ“š docs             Change to documentation only
* ğŸš€ perf             Change that affects performance
* ğŸ“¦ refactor         Change not related to a bug or feat
* ğŸ’ style            Change to style (whitespace, etc.)
* ğŸš¨ test             Change that adds/modifies tests
* ğŸš§ wip              Change that is work in progress
"""


def main():
    emojies = {
        "new": "ğŸ‰",
        "build": "ğŸ› ",
        "ci": "âš™ï¸",
        "docs": "ğŸ“š",
        "feat": "âœ¨",
        "fix": "ğŸ›",
        "perf": "ğŸš€",
        "refactor": "ğŸ“¦",
        "style": "ğŸ’",
        "test": "ğŸš¨",
        "chore": "â™»ï¸",
        "revert": "ğŸ—‘",
        "breaking": "ğŸ’¥",
        "wip": "ğŸš§",
    }
    pattern = r"({})(\([\w\-]+\))?!?:\s.*".format("|".join(emojies.keys()))
    filename = sys.argv[1]
    ss = open(filename, "r").read()
    header = [line for line in ss.splitlines() if not line.startswith("# ")][0]
    if re.match(pattern, header) is None:
        print("\nCommit header `", header, "` does not follow conventional commit specification.")
        print("\n", types)
        print("\nhttps://www.conventionalcommits.org/\n")
        sys.exit(1)
    else:
        commitPrefix = header.split(":")[0]
        commitPostfix = header.split(":")[1:]
        if "BREAKING CHANGE" in ss and not commitPrefix.endswith("!"):
            commitPrefix = commitPrefix + "!"
        commitEmoji = ""
        if os.getenv("CONVENTIONAL_COMMITS_PRECOMMIT_NOEMOJI", "false") != "true":
            if commitPrefix.endswith("!") and emojies["breaking"] not in header:
                commitEmoji = commitEmoji + " " + emojies["breaking"]
            if "(" in commitPrefix:
                e = emojies.get(commitPrefix.rstrip("!").split("(")[0], "")
            else:
                e = emojies.get(commitPrefix.rstrip("!"), "")
            if e not in header:
                commitEmoji = commitEmoji + " " + e
        else:
            commitEmoji = ""
        new_header = commitPrefix + ":" + ":".join(commitPostfix) + commitEmoji
        if new_header.strip() != header.strip():
            commit_msg = ss.replace(header, new_header)
            with open(filename, "w") as f:
                f.write(commit_msg)


if __name__ == "__main__":
    main()
